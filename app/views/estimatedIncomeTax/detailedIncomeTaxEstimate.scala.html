@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.tai.util.ViewModelHelper._
@import uk.gov.hmrc.play.views.helpers.MoneyPounds
@import uk.gov.hmrc.urls.Link
@import uk.gov.hmrc.tai.viewModels.estimatedIncomeTax.DetailedIncomeTaxEstimateViewModel
@import includes.ptaHeader
@import uk.gov.hmrc.play.views.formatting.Money._

@(viewModel: DetailedIncomeTaxEstimateViewModel)(implicit request: Request[_], messages: Messages, user: controllers.auth.TaiUser, templateRenderer: uk.gov.hmrc.renderer.TemplateRenderer, partialRetriever: uk.gov.hmrc.play.partials.FormPartialRetriever)

@gaEventActionString = @{"How your PAYE Income Tax is calculated"}

@taxYearRangeString = @{
    viewModel.currentTaxYearRangeHtmlNonBreak
}

@header = @{
    ptaHeader(
        displayBackLink = true,
        backLinkGaEventAction = Some(gaEventActionString),
        mainHeadingText = Messages("tai.estimatedIncome.detailedEstimate.heading"),
        preHeadingText = taxYearRangeString,
        preHeadingAccessibleAnnouncement = Messages("tai.estimatedIncome.accessiblePreHeading")
    )
}

@main(
    title = Messages("tai.estimatedIncome.detailedEstimate.title"),
    articleClasses = Some("full-width"),
    pageHeader = Some(header),
    user = Some(user),
    gaCustomTitle = None
){
    <div class="grid-row">
        <div class="grid grid-2-3">
            <div class="inner-block">
                <section class="soft--top flush--bottom">
                    <div class="grid-row">
                        <div class="column-one-half">
                            <h2 class="flush--bottom">
                                @Messages("tai.incomeTax.totalIncomeTaxEstimate")
                                <span id="total-income-tax-estimate" class="display-block heading-48 section faded-text flush section--narrow">
                                        @pounds(viewModel.incomeTaxEstimate)
                                </span>
                            </h2>
                        </div>
                    </div>
                </section>

                <section class="section soft--top">
                    <h3 id="tax-on-employment-income-text" class="heading-medium heading-section">@Messages("tai.estimatedIncome.detailedEstimate.employmentIncome.subHeading")</h3>
                    <p id="tax-on-employment-income-desc">
                        @Html(Messages("tai.estimatedIncome.desc",
                        pounds(viewModel.incomeEstimate),
                        Link.toInternalPage(
                        id=Some("taxFreeAmountLink"),
                        url=routes.TaxFreeAmountController.taxFreeAmount.url,
                        value=Some(Messages("tai.estimatedIncome.taxFree.link"))).toHtml,
                        pounds(viewModel.taxFreeEstimate)))
                    </p>
                    <table id="tax-on-your-employment-income-table">
                        <thead>
                        <tr>
                            <th>@Messages("tai.incomeTax.calculated.table.headingOne")</th>
                            <th>@Messages("tai.incomeTax.calculated.table.headingTwo")</th>
                            <th class="text--right">@Messages("tai.incomeTax.calculated.table.headingThree")</th>
                            <th class="text--right">@Messages("tai.incomeTax.calculated.table.headingFour")</th>
                        </tr>
                        </thead>
                        <tbody>
                        @for(taxBand <- viewModel.nonSavings.sortBy(_.rate)){
                        <tr>
                            <td>@MoneyPounds(taxBand.income,0).quantity</td>
                            <td>@Messages(s"${viewModel.taxRegion}.${taxBand.bandType}")</td>
                            <td class="text--right">@taxBand.rate%</td>
                            <td class="text--right">@MoneyPounds(taxBand.tax,2).quantity</td>
                        </tr>
                        }
                        </tbody>
                    </table>
                </section>


                <section class="section soft--top">
                    <h3 id="tax-on-dividend-income-text" class="heading-medium heading-section">@Messages("tai.estimatedIncome.detailedEstimate.dividendIncome.subHeading")</h3>
                    <p id="tax-on-dividend-income-desc">
                        @Messages("tai.estimatedIncome.dividend.para.desc")
                    </p>

                    <table id="tax-on-your-dividend-income">
                        <thead>
                            <tr>
                            <th>@Messages("tai.incomeTax.calculated.table.headingOne")</th>
                            <th>@Messages("tai.incomeTax.calculated.table.headingTwo")</th>
                            <th class="text--right">@Messages("tai.incomeTax.calculated.table.headingThree")</th>
                            <th class="text--right">@Messages("tai.incomeTax.calculated.table.headingFour")</th>
                            </tr>
                        </thead>
                        <tbody>
                        @for(taxBand <- viewModel.dividends.sortBy(_.rate)){
                            <tr>
                                <td>@MoneyPounds(taxBand.income,0).quantity</td>
                                <td>@Messages(s"${viewModel.taxRegion}.${taxBand.bandType}")</td>
                                <td class="text--right">@taxBand.rate%</td>
                                <td class="text--right">@MoneyPounds(taxBand.tax,2).quantity</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </section>

                <section class="section soft--top">
                    <h3 id="tax-on-savings-text" class="heading-medium heading-section">@Messages("tai.estimatedIncome.detailedEstimate.savingsInterest.subHeading")</h3>
                    <p id="tax-on-savings-desc">
                        @Messages("tai.estimatedIncome.savings.desc")
                    </p>
                    <table id="tax-on-your-income">
                        <thead>
                            <tr>
                            <th>@Messages("tai.incomeTax.calculated.table.headingOne")</th>
                            <th>@Messages("tai.incomeTax.calculated.table.headingTwo")</th>
                            <th class="text--right">@Messages("tai.incomeTax.calculated.table.headingThree")</th>
                            <th class="text--right">@Messages("tai.incomeTax.calculated.table.headingFour")</th>
                            </tr>
                        </thead>
                        <tbody>
                        @for(taxBand <- viewModel.savings.sortBy(_.rate)){
                        <tr>
                            <td>@MoneyPounds(taxBand.income,0).quantity</td>
                            <td>@Messages(s"${viewModel.taxRegion}.${taxBand.bandType}")</td>
                            <td class="text--right">@taxBand.rate%</td>
                            <td class="text--right">@MoneyPounds(taxBand.tax,2).quantity</td>
                        </tr>
                        }
                        </tbody>
                    </table>
                </section>

                <section>
                    @if(viewModel.hasTaxRelief){
                    <h3 id="tax-relief-title" class="heading-medium">@Messages("tai.estimatedIncome.taxrelief.title")</h3>
                    <p id="tax-relief-message">@Html(Messages(
                        "tai.estimatedIncome.taxRelief",
                        Link.toInternalPage(
                        url=routes.EstimatedIncomeTaxController.taxRelief().toString,
                        value=Some("tai.estimatedIncome.taxRelief.link")
                        ).toHtml
                        ))</p>
                    }

                    @if(viewModel.hasPotentialUnderPayment){
                    <div class="panel-indent panel-indent--info panel-indent--gutter">
                        <p id="income-potential-underpayment">@Messages("tai.potentialUnderpayment.title")</p>
                        <p id="link-potential-underpayment" data-journey='link - view:@Messages("tai.estimatedIncomeTax.howWeWorkedOut"):@Messages("tai.view.PotentialUnderpayment")' class="text">@Link.toInternalPage(url=routes.PotentialUnderpaymentController.potentialUnderpaymentPage.toString,
                            value=Some("tai.view.PotentialUnderpayment"),
                            dataAttributes=Some(Map("journey-click"->s"link - click:${Messages("tai.estimatedIncomeTax.howWeWorkedOut")}:${Messages("tai.view.PotentialUnderpayment")}."))
                            ).toHtml</p>
                    </div>
                    }

                    @viewModel.ssrValue.map { ssr =>
                    <h3 id="starting-rate-savings-title" class="heading-medium">@Messages("tai.estimatedIncome.SSR.title")</h3>
                    <p id="starting-rate-savings-text1">@Messages("tai.estimatedIncome.SSR.text1", ssr)</p>
                    }

                    @viewModel.psrValue.map { psr =>
                    <h3 id="personal-savings-allowance-title" class="heading-medium">@Messages("tai.estimatedIncome.PSA.title")</h3>
                    <p id="personal-savings-allowance-text1">@Html(Messages("tai.estimatedIncome.PSA.text1",
                        psr,
                        Link.toExternalPage(url="https://www.gov.uk/apply-tax-free-interest-on-savings", value=Some(Messages("tai.estimatedIncome.PSA.linkText"))).toHtml))</p>
                    }

                    @viewModel.dividendsMessage.map { divRateMessage =>
                    <h3 id="dividends-allowance-title" class="heading-medium">@Messages("tai.estimatedIncome.DIV.title")</h3>
                    <p id="dividendZeroRateMessage">@divRateMessage</p>
                    }

                </section>

                @if(viewModel.additionalTaxTable.size>0){
                <section>
                    <h3 id ="additionalTaxTable-heading" class="heading-medium heading-section">
                        @Messages("tai.estimatedIncome.additionalTax.title")</h3>
                    <p id="additionalTaxTable-desc">@Messages("tai.estimatedIncome.additionalTax.desc")</p>
                    <table id="additionalTaxTable" class="table-section">
                        <thead>
                        <tr>
                            @if(viewModel.additionalTaxTable.size>1) {
                                <th colspan="2">@Messages("tax.adjustments")</th>
                            } else {
                                <th colspan="2">@Messages("tax.adjustment")</th>
                            }

                        </tr>
                        </thead>
                        @for(additionalTaxRow <- viewModel.additionalTaxTable){
                        <tr>
                            <td>
                                @additionalTaxRow.label.value
                                @additionalTaxRow.label.link.map { link =>
                                    @includes.link(
                                        id=Some(link.id),
                                        copy=link.value,
                                        url = link.href,
                                        linkClasses = Seq("link-list__item"),
                                        attributes = Seq("data-journey-click"->s"link - click:${gaEventActionString}:${link.value}"))
                                }

                            </td>
                            <td class="text--right">@withPoundPrefix(MoneyPounds(additionalTaxRow.amount, 2))</td>
                        </tr>
                        }
                    </table>
                </section>
                }

                @if(viewModel.reductionTaxTable.size > 0){
                <section class="section soft--top soft--bottom">
                    <h3 id="taxPaidElsewhereTable-heading" class="heading-medium heading-section">@Messages("tai.estimatedIncome.reductionsTax.title")</h3>
                    <p id="taxPaidElsewhereTable-desc">@Messages("tai.estimatedIncome.reductionsTax.desc")</p>
                    <table id="taxPaidElsewhereTable" class="table-section">
                        <thead>
                        <tr>
                            @if(viewModel.reductionTaxTable.size>1) {
                            <th colspan="2">@Messages("tax.adjustments")</th>
                            } else {
                            <th colspan="2">@Messages("tax.adjustment")</th>
                            }
                        </tr>
                        </thead>
                        @for(taxPaidElsewhere <- viewModel.reductionTaxTable){
                        <tr>
                            <td>
                                @includes.details_summary(taxPaidElsewhere.title){
                                <p>@Html(taxPaidElsewhere.description)</p>
                                }
                            </td>
                            <td class="text--right">-@withPoundPrefix(MoneyPounds(taxPaidElsewhere.amount, 2))</td>
                        </tr>
                        }
                    </table>

                    @viewModel.incomeTaxReducedToZeroMessage.map { incomeTaxReducedToZeroMessage =>â€¨
                    <p id="reducedToZero" class="indent">@incomeTaxReducedToZeroMessage</p>
                    }
                </section>
                }
            </div>
        </div>
    </div>
}
