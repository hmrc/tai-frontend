@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import help.Link
@import uk.gov.hmrc.govukfrontend.views.html.components.{FixedWidthPageLayout, GovukBackLink, GovukLayout, TwoThirdsMainContent, TwoThirdsOneThirdMainContent, _}
@import uk.gov.hmrc.govukfrontend.views.viewmodels.backlink.BackLink
@import uk.gov.hmrc.govukfrontend.views.viewmodels.content.Text
@import uk.gov.hmrc.govukfrontend.views.viewmodels.phasebanner.PhaseBanner
@import uk.gov.hmrc.hmrcfrontend.config.AccountMenuConfig
@import uk.gov.hmrc.hmrcfrontend.controllers.routes.LanguageController.switchToLanguage
@import uk.gov.hmrc.hmrcfrontend.views.Aliases.Header
@import uk.gov.hmrc.hmrcfrontend.views.html.components.implicits.RichAccountMenu
@import uk.gov.hmrc.hmrcfrontend.views.html.helpers._
@import uk.gov.hmrc.hmrcfrontend.views.viewmodels.accountmenu.BusinessTaxAccount
@import uk.gov.hmrc.tai.config.ApplicationConfig
@import uk.gov.hmrc.tai.util.constants.TaiConstants
@import uk.gov.hmrc.webchat.client.WebChatClient
@import views.html.helper.CSPNonce
@import views.html.includes.attorneyBanner
@import uk.gov.hmrc.ptafrontend.views.html._

@this(
        govukTemplate: GovukTemplate,
        govukLayout: GovukLayout,
        govukFooter: GovukFooter,
        hmrcAccountMenu: HmrcAccountMenu,
        hmrcHeader: HmrcHeader,
        hmrcStandardHeader: HmrcStandardHeader,
        hmrcStandardFooter: HmrcStandardFooter,
        hmrcHead: HmrcHead,
        hmrcLanguageSelectHelper: HmrcLanguageSelectHelper,
        hmrcScripts: HmrcScripts,
        govukBackLink: GovukBackLink,
        defaultMainContent: TwoThirdsMainContent,
        fixedWidthPageLayout: FixedWidthPageLayout,
        twoThirdsMainContent: TwoThirdsMainContent,
        twoThirdsOneThirdMainContent: TwoThirdsOneThirdMainContent,
        hmrcTimeoutDialogHelper: HmrcTimeoutDialogHelper,
        govukPhaseBanner: GovukPhaseBanner,
        link: Link,
        appConfig: ApplicationConfig,
        hmrcReportTechnicalIssueHelper: HmrcReportTechnicalIssueHelper,
        hmrcReportTechnicalIssue: HmrcReportTechnicalIssue,
        banner: attorneyBanner,
        webChatClient: WebChatClient,
        ptaHead: PtaHead,
        ptaScripts: PtaScripts
)(implicit accountMenuConfig: AccountMenuConfig)

@(
        title: String,
        authedUser: Option[controllers.auth.AuthedUser] = None,
        pageTitle: Option[String] = None,
        backLinkUrl: Option[String] = Some("#"),
        backLinkContent: Option[String],
        backLinkId: String = "back-link",
        disableSessionExpired: Boolean = false,
        pagePrintable: Boolean = false,
        pagePrintName: Option[String] = None,
        showPtaAccountNav: Boolean = true,
        formForErrorSummary: Option[Form[_]] = None
)(content: Html)(implicit request: Request[_],
        messages: Messages)


@isUserResearchBannerHidden = @{request.cookies.exists((x: Cookie) => x.name == "mdtpurr")}

@isSa = @{
    authedUser.fold(false) {
        _.utr.isDefined
    }
}

@attorneyBanner = @{
    for {
        auth <- authedUser
        helper <- auth.trustedHelper
    } yield banner(helper)
}

@unreadMessageCount = @{
    authedUser match {
        case Some(x) => x.messageCount
        case None => None
    }
}


@additionalHeadBlock = {
    <meta name="format-detection" content="telephone=no"/>
    <link rel="stylesheet" href='@controllers.routes.Assets.versioned("stylesheets/tai.css")'/>
    @ptaHead()
    @if(!disableSessionExpired) {
        @hmrcTimeoutDialogHelper(
            signOutUrl = routes.ServiceController.sessionExpiredPage().url,
            keepAliveUrl = Some("/keep-alive")
        )
    }
    <link @CSPNonce.attr rel="stylesheet" href='@controllers.routes.Assets.versioned("stylesheets/tai.css")'/>
@if(!disableSessionExpired) {
    @hmrcTimeoutDialogHelper(
        signOutUrl = routes.ServiceController.sessionExpiredPage().url,
        keepAliveUrl = Some("/keep-alive")
    )
}
}

@urBanner = {
    <div class="hmrc-user-research-banner" data-module="hmrc-user-research-banner">
        <div class="hmrc-user-research-banner__container govuk-width-container">
            <div class="hmrc-user-research-banner__text">
                <div class="hmrc-user-research-banner__title govuk-!-font-weight-bold">
                    @{Messages("tai.urbanner.title")}
                </div>
                    <a class="govuk-link hmrc-user-research-banner__link" rel="noopener noreferrer" href="@appConfig.urBannerLink" target="_blank">
                            @{Messages("tai.urbanner.text")}
                    </a>
            </div>
            <button class="govuk-link hmrc-user-research-banner__close">
            @messages("tai.urbanner.reject")
            </button>
        </div>
    </div>
}

@headerBlock = {
    @hmrcHeader(Header(
        homepageUrl = "http://www.gov.uk",
        serviceName = pageTitle,
        serviceUrl = "",
        language = En,
        assetsPath = uk.gov.hmrc.hmrcfrontend.controllers.routes.Assets.at("govuk/images").url,
        displayHmrcBanner = false,
        inputLanguageToggle = Some(LanguageToggle((En, switchToLanguage(En.code).url), (Cy, switchToLanguage(Cy.code).url)))
    ))

    @if(!isUserResearchBannerHidden && appConfig.urBannerEnabled) {
        @urBanner
    }
}


@beforeContent = {
    @authedUser.map { auth =>
        @if(showPtaAccountNav) {
            @if(isSa && !auth.trustedHelper.isDefined) {
                @hmrcAccountMenu(AccountMenu(
                    businessTaxAccount = Some(BusinessTaxAccount()),
                    language = if(messages.lang.code == "cy") Cy else En,
                    signOut = SignOut(href = routes.ServiceController.serviceSignout().url),
                    messages = AccountMessages(messageCount = unreadMessageCount)
                ).withUrlsFromConfig())
            } else {
                @hmrcAccountMenu(AccountMenu(
                    language = if(messages.lang.code == "cy") Cy else En,
                    signOut = SignOut(href = routes.ServiceController.serviceSignout().url),
                    messages = AccountMessages(messageCount = unreadMessageCount)
                ).withUrlsFromConfig())
            }
        }

    }

    @attorneyBanner

@if(backLinkContent){
    @backLinkUrl.map(url =>
        govukBackLink(
            BackLink(classes = "js-visible-back",
            attributes = Map("id" -> backLinkId),
            href = url,
            content = Text(backLinkContent.get)))
        )
    }
}



@contentBlock = {
    @content
    <div class="govuk-grid-row govuk-!-margin-top-9">
        <div class="govuk-grid-column-one-half govuk-!-margin-bottom-5">
        @hmrcReportTechnicalIssueHelper()
        </div>
    </div>


    @govukPhaseBanner(PhaseBanner(
        tag = Some(Tag(
            content = Text("beta")
        )),
        content = HtmlContent(messages("betaBanner.message",
            link(link = appConfig.betaFeedbackUnauthenticatedUrl,
                messageKey = "betaBanner.linkText",
                inParagraph = true)))
    ))
}


@fullPageTitle = @{
    val prefix =
        if(formForErrorSummary.exists(_.errors.nonEmpty)) {
            s"${Messages("tai.page.title.error")} "
        } else {
            ""
        }
    s"$prefix$title - ${Messages("tai.currentYearSummary.heading")} - GOV.UK"
}


@accessibilityStatementUrl = @{
    (appConfig.accessibilityStatementUrl(request.uri))
}


@mainContentDefault = {
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full-width govuk-!-margin-left-3 govuk-!-margin-right-3">
        @contentBlock
        </div>
    </div>
}


@footerBlock = @{
    Some(hmrcStandardFooter(accessibilityStatementUrl = Some(accessibilityStatementUrl.toString())))
}

@footerDefault = {
@footerBlock.getOrElse("")
}


@addPrintableClass = @{
    if(pagePrintable) {
        "printable-page " + pagePrintName.getOrElse("")
    } else ""
}

@additionalScriptsBlock = {
    @ptaScripts()
    <script @CSPNonce.attr src='@controllers.routes.AssetsController.versioned("javascripts/newcard.js")'></script>
    <script @CSPNonce.attr src='@controllers.routes.AssetsController.versioned("javascripts/backlink.js")'></script>
    <script @CSPNonce.attr src='@controllers.routes.AssetsController.versioned("javascripts/print.js")'></script>


    <script @CSPNonce.attr type="text/javascript">
            window.onload = function() {
                var htmlElem = document.querySelector('html')
                var techIssueLink =  document.querySelector('a.hmrc-report-technical-issue');
                var lang = techIssueLink.getAttribute('lang')
                htmlElem.setAttribute("lang", lang);
            }
    </script>
    @if(appConfig.webChatIsEnabled) {
      @{webChatClient.loadRequiredElements()}
      @{webChatClient.loadWebChatContainer("HMRC_Anchored_1")}
    }
}


@govukTemplate(
    htmlLang = Some("en"),
    pageTitle = Some(fullPageTitle),
    headBlock = Some(hmrcHead(headBlock = Some(additionalHeadBlock))),
    headerBlock = headerBlock,
    beforeContentBlock = Some(beforeContent),
    mainClasses = Some("govuk-main-wrapper--auto-spacing"),
    bodyClasses = Some(addPrintableClass),
    bodyEndBlock = Some(hmrcScripts(scriptsBlock = Some(additionalScriptsBlock))),
    footerBlock = footerDefault
)(mainContentDefault)


