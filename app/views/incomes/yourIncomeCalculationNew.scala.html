@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.tai.util.CeasedEmploymentHelper
@import uk.gov.hmrc.tai.util.TaiConstants._
@import uk.gov.hmrc.urls.Link
@import uk.gov.hmrc.tai.viewModels.YourIncomeCalculationViewModelNew
@import uk.gov.hmrc.time.TaxYearResolver
@import uk.gov.hmrc.tai.model.domain.income._
@import uk.gov.hmrc.tai.model.domain._
@import uk.gov.hmrc.play.language.LanguageUtils.Dates
@import uk.gov.hmrc.time.TaxYearResolver
@import includes.ptaHeader

@(model: YourIncomeCalculationViewModelNew)(implicit request: Request[_], user: controllers.auth.TaiUser, messages: Messages, templateRenderer: uk.gov.hmrc.renderer.TemplateRenderer, partialRetriever: uk.gov.hmrc.play.partials.FormPartialRetriever)
@gaEventActionString = @{"Taxable income"}

@printLink= {
    <p class="flush--bottom">
    @Link.toInternalPage(
        url=routes.YourIncomeCalculationController.printYourIncomeCalculationPage(model.empId).toString,
        value=Some(Messages("tai.label.print")),
        cssClasses=Some("tai-print-link")).toHtml
    </p>
}

@header = @{
    ptaHeader(
        displayBackLink = true,
        backLinkGaEventAction = Some(gaEventActionString),
        mainHeadingText = Messages("tai.income.calculation.TaxableIncomeDetails", model.employerName),
        preHeadingText = "Income received to date",
        preHeadingAccessibleAnnouncement = "This section is the income tax summary for",
        additionalTopLinkContent = Some(printLink))
}

@main(
    title = Messages("tai.income.calculation.TaxableIncomeDetails", model.employerName),
    user = Some(user),
    pageHeader = Some(header),
    employerName = Some(model.employerName),
    gaCustomTitle = None,
    articleClasses = None
){

    <div class="grid-row">

            <div class="inner-block">
                <div class="subsection">
                    @model.employmentStatus match {
                        case PotentiallyCeased => {
                            @if(model.latestPayment.isDefined) {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading.withRti", Dates.formatDate(model.latestPayment.get.date))</h2>
                            } else {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading",s"${Dates.formatDate(TaxYearResolver.startOfCurrentTaxYear)}",s"${Dates.formatDate(TaxYearResolver.endOfCurrentTaxYear)}")</h2>
                            }

                            <p>@Messages("tai.income.calculation.potentially.ceased.lede")</p>
                        }

                        case Ceased => {
                            @if(model.latestPayment.isDefined) {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.ceased.heading", Dates.formatDate(model.latestPayment.get.date))</h2>
                            } else {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading",s"${Dates.formatDate(TaxYearResolver.startOfCurrentTaxYear)}",s"${Dates.formatDate(TaxYearResolver.endOfCurrentTaxYear)}")</h2>
                            }

                            <p>@Messages("tai.income.calculation.rti.ceased.emp",s"${CeasedEmploymentHelper.toDisplayFormat(model.endDate)}")</p>
                        }

                        case _ => {
                            @if(model.latestPayment.isDefined) {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading.withRti", Dates.formatDate(model.latestPayment.get.date))</h2>
                            } else {
                                <h2 class="heading-medium">@Messages("tai.income.calculation.heading",s"${Dates.formatDate(TaxYearResolver.startOfCurrentTaxYear)}",s"${Dates.formatDate(TaxYearResolver.endOfCurrentTaxYear)}")</h2>
                            }

                            @if(model.rtiStatus == TemporarilyUnavailable) {
                                <p id="rtiUnavailableCurrentYear">@Messages("tai.income.calculation.rtiUnavailableCurrentYear.message")</p>
                                <p id="rtiUnavailableCurrentYearContact">@Messages("tai.income.calculation.rtiUnavailableCurrentYear.message.contact")</p>
                            } else {
                                <p id="incomeCalculationMsg@model.empId">@model.incomeCalculationMessage</p>
                            }
                        }
                    }
                </div>

                @if(model.latestPayment.isDefined) {
                    <div class="section soft--top soft--bottom">
                        <table id="taxable-income-table" class="table-section">
                            <caption class="text--left table__caption table__caption--bottom-border visually-hidden">@Messages("tai.income.calculation.incomeTable.caption")</caption>
                            <thead>
                                <tr>
                                    <th>@Messages("tai.income.calculation.incomeTable.dateHeader")</th>
                                    <th class="text--right">@Messages("tai.income.calculation.incomeTable.incomeHeader")</th>
                                    <th class="text--right">@Messages("tai.income.calculation.incomeTable.taxPaidHeader")</th>
                                    <th class="text--right">@Messages("tai.income.calculation.incomeTable.nationalInsuranceHeader")</th>
                                </tr>
                            </thead>
                            <tfoot>
                                <tr class="table__row--bold">
                                    <td>@Messages("tai.taxFree.total")</td>
                                    <td class="text--right">@{f"${model.latestPayment.get.amountYearToDate}%,.2f"}</td>
                                    <td class="text--right">@{f"${model.latestPayment.get.taxAmountYearToDate}%,.2f"}</td>
                                    <td class="text--right">@{f"${model.latestPayment.get.nationalInsuranceAmountYearToDate}%,.2f"}</td>
                                </tr>
                            </tfoot>
                            <tbody>
                                @for(payment <- model.payments){
                                    <tr class="pension-contributions-data">
                                        <td>@Dates.formatDate(payment.date)</td>
                                        <td class="text--right">@{f"${payment.taxableIncome}%,.2f"}</td>
                                        <td class="text--right">@{f"${payment.taxAmount}%,.2f"}</td>
                                        <td class="text--right">@{f"${payment.nationalInsuranceAmount}%,.2f"}</td>
                                    </tr>
                                }
                            </tbody>
                        </table>

                        @model.messageWhenTotalNotEqual.map { message =>
                            <p>@message</p>
                            <p>@Messages("tai.income.calculation.totalNotMatching.message")</p>
                        }
                    </div>
                }


                @model.employmentStatus match {
                    case PotentiallyCeased => {
                        @if(model.isPension) {
                            <h4 class="heading-small">@model.incomeCalculationEstimateMessage</h4>
                            <p>@Html(Messages(
                                "tai.yourTaxableIncome.otherDetailsWrongPensionIform",
                                Link.toInternalPage(url=routes.AuditController.auditLinksToIForm(EmployeePensionIForm).url, value=Some(Messages("tai.yourTaxableIncome.otherDetailsWrongIformLink"))).toHtml
                                ))
                            </p>
                        } else {
                            <h4 class="heading-small">@model.incomeCalculationEstimateMessage</h4>
                        }
                    }

                    case Ceased => {
                        @if(model.incomeCalculationEstimateMessage.isDefined){
                            <h3 class="heading-small">@model.incomeCalculationEstimateMessage</h3>
                        }

                        @if(model.hasPayrolledBenefit){
                            <div class="panel-indent panel-indent--info panel-indent--gutter">
                                <p id="payrolling1">@Messages("tai.income.calculation.payrollingBik.message1")</p>
                                <p id="payrolling2">@Messages("tai.income.calculation.payrollingBik.message2")</p>
                            </div>
                        }
                    }

                    case _ => {

                        @if(model.incomeCalculationEstimateMessage.isDefined){
                            <h3 class="heading-small">@model.incomeCalculationEstimateMessage</h3>
                        }

                        @if(model.hasPayrolledBenefit){
                            <div class="panel-indent panel-indent--info panel-indent--gutter">
                                <p id="payrolling1">@Messages("tai.income.calculation.payrollingBik.message1")</p>
                                <p id="payrolling2">@Messages("tai.income.calculation.payrollingBik.message2")</p>
                            </div>
                        }

                        @if(model.isPension){
                            <p id="pensionUpdateLink">@Html(Messages(
                                "tai.income.calculation.update.pension",
                                Link.toInternalPage(url=routes.IncomeUpdateCalculatorController.howToUpdatePage(model.empId).toString, value=Some(Messages("tai.income.calculation.updateLink.regular"))).toHtml
                                ))</p>
                            <p id="pensionIFormLink">@Html(Messages(
                                "tai.yourTaxableIncome.otherDetailsWrongPensionIform",
                                Link.toInternalPage(url=routes.AuditController.auditLinksToIForm(EmployeePensionIForm).url, value=Some(Messages("tai.yourTaxableIncome.otherDetailsWrongIformLink"))).toHtml
                                ))
                            </p>
                        } else {
                            <p id="regularUpdateLink">@Html(Messages(
                                "tai.income.calculation.update.regular",
                                Link.toInternalPage(url=routes.IncomeUpdateCalculatorController.howToUpdatePage(model.empId).toString, value=Some(Messages("tai.income.calculation.updateLink.regular"))).toHtml
                                ))
                            </p>
                        }
                    }

                }

                @if(!model.isPension){
                    <p>@Html(Messages(
                        "tai.yourTaxableIncome.otherDetailsWrongIform",
                        Link.toInternalPage(url=routes.AuditController.auditLinksToIForm(EmployeePensionIForm).url, value=Some(Messages("tai.yourTaxableIncome.otherDetailsWrongIformLink"))).toHtml
                        ))
                    </p>
                }

            </div>
    </div>
}