@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import includes.ptaHeader
@import includes.link
@import uk.gov.hmrc.play.views.html.helpers._
@import uk.gov.hmrc.tai.config.ApplicationConfig
@import uk.gov.hmrc.tai.model.domain.{Available, TemporarilyUnavailable}
@import uk.gov.hmrc.tai.model.TaxYear
@import uk.gov.hmrc.tai.viewModels.HistoricIncomeCalculationViewModel
@import uk.gov.hmrc.tai.util.{TaxYearRangeUtil => Dates}
@import controllers.auth.AuthenticatedRequest

@this(main: MainTemplate)

@(historicIncomeCalculationViewModel: HistoricIncomeCalculationViewModel
)(implicit request: AuthenticatedRequest[_], messages: Messages, templateRenderer: uk.gov.hmrc.renderer.TemplateRenderer, ec : scala.concurrent.ExecutionContext)

@header = @{
    ptaHeader(
        mainHeadingText = messages("tai.income.calculation.TaxableIncomeDetails", historicIncomeCalculationViewModel.employerName.getOrElse("")),
        preHeadingText = messages("tai.yourIncome.preHeading"),
        showGdsVersion = true)
}

@main(
    title = messages("tai.yourIncome.heading"),
    authedUser = Some(request.taiUser),
    backLinkContent = Some(Messages("tai.back-link.upper")),
    pagePrintable = true
){

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            @header
        </div>
    </div>
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <div class="inner-block">
        @historicIncomeCalculationViewModel.realTimeStatus match {
        case Available if historicIncomeCalculationViewModel.payments.nonEmpty => {
        <div class="subsection subsection--wide">
            <p id="previous-year-summary-message" class="govuk-body">
                @messages("tai.income.calculation.summary.previous",Dates.formatDate(historicIncomeCalculationViewModel.payments.head.date),Dates.formatDate(historicIncomeCalculationViewModel.payments.last.date))</p>
            @if(historicIncomeCalculationViewModel.endOfTaxYearUpdateMessages.nonEmpty) {
            @historicIncomeCalculationViewModel.employerName.map { name =>
            <p id="eyu-message-previous" class="govuk-body">@messages("tai.income.calculation.eyu.previous", name)</p>
            }
            } else {
            @historicIncomeCalculationViewModel.employerName.map { name =>
            <p class="govuk-body">@messages("tai.income.calculation.previous", name)</p>
            }
            }
        </div>
        <div class="section soft--top soft--bottom">
            <table id="taxable-income-table" class="govuk-table">
                <caption class="text--left table__caption table__caption--bottom-border govuk-visually-hidden">
                    @messages("tai.income.calculation.incomeTable.caption")
                </caption>
                <thead class="govuk-table__head">
                <tr>
                    <th class="govuk-table__header govuk-table__header--text govuk-!-width-one-quarter">
                        @messages("tai.income.calculation.incomeTable.dateHeader")
                    </th>
                    <th class="govuk-table__header govuk-table__header--numeric govuk-!-width-one-quarter">
                        @messages("tai.income.calculation.incomeTable.incomeHeader")
                    </th>
                    <th class="govuk-table__header govuk-table__header--numeric govuk-!-width-one-quarter">
                        @messages("tai.income.calculation.incomeTable.taxPaidHeader")
                    </th>
                    <th class="govuk-table__header govuk-table__header--numeric govuk-!-width-one-quarter">
                        @messages("tai.income.calculation.incomeTable.nationalInsuranceHeader")
                    </th>
                </tr>
                </thead>
                <tbody class="govuk-table__body">
                @for(payment <- historicIncomeCalculationViewModel.payments){
                <tr class="govuk-table__row">
                    <td class="govuk-table__cell">@Dates.formatDate(payment.date)</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">@{f"${payment.amount}%,.2f"}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">@{f"${payment.taxAmount}%,.2f"}</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric">
                        @{f"${payment.nationalInsuranceAmount}%,.2f"}
                    </td>
                </tr>
                }
                <tr class="table__row--bold">
                    <td class="govuk-table__cell govuk-!-font-weight-bold">@messages("tai.taxFree.total")</td>
                    <td class="govuk-table__cell govuk-table__cell--numeric govuk-!-font-weight-bold">
                        @{f"${historicIncomeCalculationViewModel.payments.last.amountYearToDate}%,.2f"}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric govuk-!-font-weight-bold">
                        @{f"${historicIncomeCalculationViewModel.payments.last.taxAmountYearToDate}%,.2f"}
                    </td>
                    <td class="govuk-table__cell govuk-table__cell--numeric govuk-!-font-weight-bold">
                        @{f"${historicIncomeCalculationViewModel.payments.last.nationalInsuranceAmountYearToDate}%,.2f"}
                    </td>
                </tr>
                </tbody>
            </table>

            <div id="eyu-messages" class="section flush--bottom soft--bottom">
                <div class="eyu-multi-messages">
                    @if(historicIncomeCalculationViewModel.endOfTaxYearUpdateMessages.size == 1) {
                    <p class="govuk-body">
                        @messages("tai.income.calculation.eyu.summary.single",
                        historicIncomeCalculationViewModel.employerName.getOrElse("")) </p>
                    <p class="govuk-body">@historicIncomeCalculationViewModel.endOfTaxYearUpdateMessages.head</p>
                    }
                    @if(historicIncomeCalculationViewModel.endOfTaxYearUpdateMessages.size > 1) {
                    <p class="govuk-body">@messages("tai.income.calculation.eyu.summary.multi",
                        historicIncomeCalculationViewModel.employerName.getOrElse(""))</p>
                    <ul id="eyu-multi-messages-bullets" class="govuk-list govuk-list--bullet" style="padding-left: 3%">
                        @for(eyuMessage <- historicIncomeCalculationViewModel.endOfTaxYearUpdateMessages){
                        <li>@eyuMessage</li>
                        }
                    </ul>
                    }
                </div>
            </div>

        </div>
        }
        case _ => {
            <div class="subsection subsection--wide">
                <p class="govuk-body">
                    @messages("tai.income.calculation.noRtiDataPreviousYear",Dates.formatDate(TaxYear(historicIncomeCalculationViewModel.taxYear.year).end))</p>
            </div>
        }
        }
            <div class="print-this">
                <a id="print-link-btn" href="@routes.YourIncomeCalculationController.printYourIncomeCalculationHistoricYears(historicIncomeCalculationViewModel.taxYear,historicIncomeCalculationViewModel.employmentId).toString"
                   class="print-this__link" href="javascript:window.print()">@Messages("tai.label.print")</a>
            </div>
    </div>
    </div>
    </div>

}
