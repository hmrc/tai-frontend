@*
 * Copyright 2021 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Play
@import uk.gov.hmrc.http.SessionKeys
@import uk.gov.hmrc.play.views.helpers.AttorneyRegime.standAlone
@import uk.gov.hmrc.tai.util.constants.TaiConstants
@import uk.gov.hmrc.tai.config.{ApplicationConfig, FeatureTogglesConfig}
@import uk.gov.hmrc.play.language.LanguageUtils
@import uk.gov.hmrc.tai.viewModels.GoogleAnalyticsSettings
@import uk.gov.hmrc.webchat.client.WebChatClient
@import uk.gov.hmrc.play.views.helpers.AttorneyRegime
@import uk.gov.hmrc.play.views.html.layouts._

@this(
    webChatClient: WebChatClient,
    appConfig: ApplicationConfig,
    langUtils: LanguageUtils,
    trackingConsentSnippet: TrackingConsentSnippet,
    article: Article,
    sidebar: Sidebar,
    attorney_banner: AttorneyBanner
)

@(title: String,
    sidebarLinks: Option[Html] = None,
    sidebarClass: Option[String] = None,
    articleClasses: Option[String] = Some("full-width"),
    authedUser: Option[controllers.auth.AuthedUser] = None,
    employerName: Option[String] = None,
    includeGridWrapper: Boolean = false,
    optimizelyAudience: Option[String] = None,
    pageHeader: Option[Html] = None,
    script: Option[Html] = None
)(mainContent: Html)(
    implicit request: Request[_],
    messages: Messages,
    templateRenderer: uk.gov.hmrc.renderer.TemplateRenderer
)

@serviceSuffix = @{
    s"- ${Messages("tai.service.navTitle")} - GOV.UK"
}

@authProvider = @{
    authedUser.map {
        _.providerType
    }
}

@isGG = @{
    authedUser.fold(false) {
        _.providerType.contains(TaiConstants.AuthProviderGG)
    }
}

@isSa = @{
    authedUser.fold(false) {
        _.utr.isDefined
    }
}

@mustacheCheck(str: String) = @{
    if(str.trim == "") false else str
}

@signOutUrl = @{""}

@trustedHelperBanner = {
    @{
        authedUser.map(_.trustedHelper.map{ helper =>
            attorney_banner(Some(helper.principalName), helper.returnLinkUrl, AttorneyRegime.standAlone)
        })
    }
}

@mainContentHeader = {
    @pageHeader.getOrElse(Html(""))
}

@sidebarSection = @{
    sidebarLinks.map { sidebarLinksValue =>
        sidebar(sidebarLinksValue, sidebarClass)
    }
}

@sessionId = @{ request.session.get("sessionId") }

@headInlineScript = {
    @trackingConsentSnippet()
}

@inlineScript = {
    @{webChatClient.loadWebChatContainer("HMRC_Anchored_1")}
    @{webChatClient.loadRequiredElements()}
    @script
}

@isWelshEnabled = @{
    appConfig.welshLanguageEnabled
}

@isWelshActive = @{
    langUtils.getCurrentLang == Lang("cy")
}

@accessibilityFooterUrl = {
    @appConfig.accessibilityStatementUrl(request.uri)
}

@mustacheMap = @{
    Map[String, Any](
        "pageTitle" -> s"${title} ${serviceSuffix}",
        "linkElems" -> Map(
            "url" -> controllers.routes.AssetsController.versioned("stylesheets/tai.css")
        ),
        "navTitle" -> Messages("tai.service.navTitle"),
        "hasNavLinks" -> true,
        "navLinks" -> Map(
            "url" -> signOutUrl,
            "text" -> "Sign out"
        ),
        "isGovernmentGateway" -> isGG,
        "isSa" -> isSa,
        "hideAccountMenu" -> true,
        "signOutUrl" -> signOutUrl,
        "mainContentHeader" -> mainContentHeader,
        "sidebar" -> sidebarSection,
        "betaBanner" -> false,
        "feedbackIdentifier" -> TaiConstants.SERVICE_IDENTIFIER,
        "scriptElems" -> Seq(
            Map("url" -> controllers.routes.AssetsController.versioned("javascripts/tai-app.js"))
        ),
        "inlineScript" -> inlineScript,
        "headInlineScript" -> headInlineScript,
        "showPropositionLinks" -> isWelshEnabled,
        "langSelector" -> isWelshEnabled,
        "enUrl" -> controllers.i18n.routes.TaiLanguageController.english(),
        "cyUrl" -> controllers.i18n.routes.TaiLanguageController.welsh(),
        "isWelsh" -> isWelshActive,
        "actingAttorneyBanner" -> trustedHelperBanner
    )
}

@extraTemplateArguments = @{
    if(appConfig.accessibilityStatementToggle) {
        mustacheMap ++ Map[String,Any]("accessibilityFooterUrl" -> accessibilityFooterUrl)
    } else mustacheMap
}

@{
    templateRenderer.renderDefaultTemplate(appConfig.frontendTemplatePath, article(content = mainContent, includeGridWrapper = includeGridWrapper, articleClasses), extraTemplateArguments)
}
